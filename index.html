<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YONOP</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <link rel="stylesheet" href="css/pages/index.css" />
  <style>
    /* منع تحديد النص في جميع أنحاء الموقع */
    * {
      -webkit-user-select: none;  /* Chrome/Safari/Opera */
      -moz-user-select: none;     /* Firefox */
      -ms-user-select: none;      /* Internet Explorer/Edge */
      user-select: none;          /* Non-prefixed version */
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      position: fixed;
    }

    html {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    html::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    body::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    /* السماح بتحديد النص في حقول الإدخال */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    :root {
      --blue: #9FC5EF;
      --bodyFont: #2b3445;
      --bg: #f6f6f6;
    }

    a, button {
      all: unset;
      display: inline-block;
      transition: 0.2s;
    }

    button:active, a:active {
      scale: 0.9;
    }

    button:hover, a:hover {
      cursor: pointer;
    }

    header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 20px 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
    }

    .logo {
      font-weight: bold;
      font-size: 4rem;
      color: var(--bodyFont);
      display: flex;
      align-items: center;
      text-decoration: none;
    }

    .logo i {
      margin-right: 1rem;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      border: 1px solid var(--bodyFont);
      padding: 0.44rem 1rem;
      border-radius: 55px;
      font-size: 0.8rem;
      font-weight: 500;
      background: transparent;
      color: var(--bodyFont);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background-color: var(--bodyFont);
      color: var(--blue);
    }

    .cart-btn {
      position: relative;
    }

    .cart-total {
      display: none;
    }

    .products-number {
      position: absolute;
      right: -5px;
      top: -5px;
      height: 20px;
      width: 20px;
      background-color: rgb(255, 90, 123);
      color: #fff;
      font-size: 0.7rem;
      font-weight: bold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .top-img {
      position: relative;
      background-image: url("images/your-image.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 5%;
      color: #2b2b2b;
      overflow: hidden;
    }

    .content {
      max-width: 600px;
      opacity: 0;
      animation: fadeUp 1s ease forwards;
      z-index: 10;
      position: relative;
    }

    .content .lifestyle {
      text-transform: uppercase;
      color: #444;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .content .men {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .content .sale {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .content .sale span {
      color: red;
    }

    .content .shipping {
      font-size: 1rem;
      color: #555;
      margin-bottom: 1.2rem;
    }

    .shop-now-btn {
      border: 1px solid black;
      padding: 0.8rem 2rem;
      border-radius: 30px;
      font-weight: bold;
      font-size: 1rem;
      color: black;
      background-color: transparent;
      transition: all 0.3s ease;
    }

    .shop-now-btn:hover {
      background-color: black;
      color: white;
    }

    .person-img {
      width: 800px;
      height: auto;
      position: absolute;
      bottom: 0;
      right: 5%;
      z-index: 5;
      opacity: 0;
      transform: translateX(100px);
      animation: fadeInRight 1.5s ease forwards;
      animation-delay: 1s;
      pointer-events: none;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @media (max-width: 768px) {
      .logo {
        display: none;
      }

      .actions {
        flex-direction: row;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn {
        max-width: none;
      }

      .top-img {
        padding: 8rem 1rem 2rem;
      }

      .person-img {
        width: 300px;
        right: 0;
        bottom: 0;
      }

      .content {
        text-align: center;
      }
    }

    .cart-count {
      display: inline-block;
      min-width: 20px;
      padding: 0 5px;
      background-color: #ff69b4;
      color: white;
      border-radius: 10px;
      font-size: 0.8rem;
      text-align: center;
      margin-left: 5px;
      transition: all 0.3s ease;
    }

    .cart-btn .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #ff69b4;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .nav-icons {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      margin-top: 1.5rem;
    }

    .nav-icon {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0.5rem 1.3rem;
      border: 2px solid var(--bodyFont);
      border-radius: 30px;
      background: rgba(255,255,255,0.05);
      color: var(--bodyFont);
      font-size: 1.1rem;
      font-weight: 500;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: none;
    }

    .nav-icon i {
      font-size: 1.2em;
    }

    .nav-icon:hover {
      background: var(--bodyFont);
      color: var(--blue);
      border-color: var(--blue);
    }

    .nav-label {
      margin-left: 4px;
      font-size: 1.08rem;
      color: inherit;
      font-weight: 500;
      vertical-align: middle;
      letter-spacing: 0.5px;
    }

    #loginModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #loginModal > div {
      background: #fff;
      color: #222;
      border-radius: 18px;
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      min-width: 340px;
      max-width: 95vw;
      margin: auto;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18), 0 1.5px 8px rgba(255,105,180,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #loginModal h2 {
      margin-bottom: 1.5rem;
      color: #ff69b4;
      font-size: 2.3rem;
      font-weight: 800;
      text-align: center;
      width: 100%;
      letter-spacing: 1px;
      padding: 0 2.5rem 0 1.5rem;
      box-sizing: border-box;
      display: block;
    }
    #loginModal label {
      font-size: 1.08rem;
      color: #444;
      margin-bottom: 0.3rem;
      display: block;
    }
    #loginModal input[type="text"],
    #loginModal input[type="password"] {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border-radius: 7px;
      border: 1.5px solid #ccc;
      font-size: 1.08rem;
      margin-bottom: 1.1rem;
      background: #f7f7fa;
      transition: border 0.2s;
    }
    #loginModal input:focus {
      border: 1.5px solid #ff69b4;
      outline: none;
    }
    #loginModal button[type="submit"] {
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.9rem 0;
      font-weight: bold;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 0.5rem;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(255,105,180,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #loginModal button[type="submit"]:hover {
      background: #ff3380;
    }
    #loginModal .close-btn {
      position: absolute;
      top: 15px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.7rem;
      color: #ff69b4;
      cursor: pointer;
      transition: color 0.2s;
    }
    #loginModal .close-btn:hover {
      color: #ff3380;
    }
    #loginModal #loginError {
      color: #e74c3c;
      font-size: 1rem;
      margin-bottom: 0.7rem;
      display: none;
      text-align: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }

    #forgotPasswordModal {
      background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
    }

    #forgotPasswordModal input:focus {
      border-color: #ff69b4 !important;
      box-shadow: 0 0 0 3px rgba(255,105,180,0.1);
      outline: none;
      transform: translateY(-2px);
    }

    #forgotPasswordModal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,105,180,0.4);
    }

    #forgotPasswordModal .close-btn:hover {
      transform: rotate(90deg);
    }

    .modal-content {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .form-input {
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.9);
    }

    .form-input:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .submit-btn {
      background: linear-gradient(45deg, #ff69b4, #ff3380);
      position: relative;
      overflow: hidden;
    }

    .submit-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .error-message {
      animation: pulse 0.5s ease;
      background: linear-gradient(145deg, #fff5f5, #ffe5e5);
      border: 1px solid rgba(231,76,60,0.2);
    }

    .success-message {
      animation: float 2s ease-in-out infinite;
      background: linear-gradient(145deg, #f0fff0, #e0ffe0);
      border: 1px solid rgba(46,204,113,0.2);
    }

    button, .submit-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toCodeStep {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 0 0 #ff69b4aa, 0 0 0 0 #fff; }
      50% { box-shadow: 0 0 24px 8px #ff69b4cc, 0 0 12px 4px #fff; }
      100% { box-shadow: 0 0 0 0 #ff69b4aa, 0 0 0 0 #fff; }
    }

    @keyframes floatText {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .loader-glow {
      width: 56px;
      height: 56px;
      border: 7px solid #ff69b4;
      border-top: 7px solid #fff;
      border-right: 7px solid #ffb6d5;
      border-radius: 50%;
      animation: spin 1s linear infinite, glow 2s infinite;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg,#fff 60%,#ffe5f7 100%);
    }

    .loading-text {
      font-size: 1.22rem;
      color: #ff3380;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 2px 12px #ffb6d5, 0 1px 2px #fff;
      animation: floatText 2.2s infinite;
      transition: color 0.2s;
    }
  </style>
</head>
<body>
  <div class="top-img">
    <header>
      <div class="logo">
        <i class="fa-solid fa-bag-shopping"></i>
        YONOP
      </div>
      <div class="actions">
        <div class="nav-icons">
          <a href="pages/register.html" class="nav-icon" id="registerLink">
            <i class="fas fa-user-plus"></i> <span class="nav-label">Register</span>
          </a>
          <a href="#" class="nav-icon" id="signinLink" style="display: block;">
            <i class="fa-solid fa-circle-user"></i> <span class="nav-label">Sign in</span>
          </a>
          <a href="#" class="nav-icon" id="logoutLink" style="display: none;">
            <i class="fas fa-door-open"></i> <span class="nav-label">Log out</span>
          </a>
          <a href="pages/profile.html" class="nav-icon" id="profileLink" style="display: none;">
            <i class="fas fa-user"></i> <span class="nav-label">Profile</span>
          </a>
        </div>
      </div>
    </header>

    <section class="content">
      <div class="lifestyle">Lifestyle Collection</div>
      <div class="men">MEN</div>
      <div class="sale">SALE UP TO <span>30% OFF</span></div>
      <div class="shipping">Get Free Shipping on orders over MAD 99.00</div>
      <a href="pages/product-details.html" class="shop-now-btn">Shop Now</a>
    </section>

    <img src="assets/persen.png" alt="persen" class="person-img" />
  </div>

  <!-- مودال تسجيل الدخول -->
  <div id="loginModal">
    <div>
      <h2>Sign In</h2>
      <form id="loginForm" style="width:100%;max-width:340px;">
        <div style="margin-bottom:1rem;">
          <label>Username</label>
          <input type="text" id="loginUsername" required>
        </div>
        <div style="margin-bottom:1rem;">
          <label>Password</label>
          <input type="password" id="loginPassword" required>
        </div>
        <div id="loginError"></div>
        <button type="submit">Sign In</button>
        <div style="text-align:center;margin-top:1rem;">
          <a href="#" id="forgotPasswordLink" style="color:#ff69b4;font-size:0.98rem;text-decoration:underline;cursor:pointer;">نسيت كلمة المرور؟</a>
        </div>
      </form>
      <button class="close-btn" onclick="document.getElementById('loginModal').style.display='none'">&times;</button>
    </div>
  </div>

  <!-- مودال نسيت كلمة المرور -->
  <div id="forgotPasswordModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
    <div class="modal-content" style="background:#fff;color:#222;border-radius:25px;max-width:95vw;width:400px;padding:3rem 2.5rem 2.5rem 2.5rem;position:relative;overflow-y:auto;max-height:90vh;display:flex;flex-direction:column;align-items:center;transform:scale(0.9);opacity:0;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
      <button onclick="document.getElementById('forgotPasswordModal').style.display='none'" style="position:absolute;top:20px;right:25px;background:none;border:none;font-size:1.8rem;color:#ff69b4;cursor:pointer;transition:all 0.3s ease;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;">&times;</button>
      <h3 style="color:#ff69b4;text-align:center;font-size:1.6rem;margin-bottom:2rem;font-weight:800;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,0.1);">استرجاع كلمة المرور</h3>
      <form id="forgotPasswordForm" style="width:100%;max-width:340px;">
        <label style="display:block;margin-bottom:0.8rem;color:#555;font-size:1.1rem;font-weight:500;">البريد الإلكتروني المسجل</label>
        <input type="email" id="forgotEmail" required class="form-input" style="width:100%;padding:1rem 1.2rem;border-radius:15px;border:2px solid #eee;font-size:1.1rem;margin-bottom:1.5rem;background:#f8f9fa;transition:all 0.3s ease;">
        <div id="forgotError" class="error-message" style="color:#e74c3c;font-size:1rem;margin-bottom:1rem;display:none;text-align:center;padding:1rem;border-radius:12px;"></div>
        <button type="submit" class="submit-btn" style="background:linear-gradient(45deg, #ff69b4, #ff3380);color:#fff;border:none;border-radius:15px;padding:1.1rem 0;font-weight:bold;width:100%;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 20px rgba(255,105,180,0.3);position:relative;overflow:hidden;">إعادة معاينة البيانات</button>
      </form>
      <div id="securityStep" style="display:none;width:100%;max-width:340px;animation:fadeIn 0.5s ease;"></div>
      <div id="codeStep" style="display:none;width:100%;max-width:340px;animation:fadeIn 0.5s ease;"></div>
      <div id="finalError" class="error-message" style="display:none;color:#e74c3c;font-size:1.1em;margin-top:1.5rem;text-align:center;padding:1.2rem;border-radius:12px;animation:shake 0.5s ease;"></div>
    </div>
  </div>

  <!-- إضافة مكتبة bcryptjs للتشفير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>

  <script>
  // إضافة حدث النقر على الشعار لتحديث الصفحة
  document.addEventListener('DOMContentLoaded', function() {
    const logo = document.querySelector('.logo');
    if (logo) {
      logo.addEventListener('click', function() {
        // إضافة تأثير الضغط
        logo.style.transform = 'scale(0.95)';
        setTimeout(() => {
          logo.style.transform = 'scale(1)';
          location.reload();
        }, 150);
      });
    }
  });

  // حماية إضافية: إخفاء زر تسجيل الخروج دائمًا عند تحميل الصفحة
  document.addEventListener('DOMContentLoaded', function() {
    var logoutLink = document.getElementById('logoutLink');
    if (logoutLink) logoutLink.style.display = 'none';
  });

  document.addEventListener('DOMContentLoaded', function() {
    const cartCount = document.getElementById('cartCount');
    const registerLink = document.getElementById('registerLink');
    const signinLink = document.getElementById('signinLink');
    const logoutLink = document.getElementById('logoutLink');
    const profileLink = document.getElementById('profileLink');

    function updateCartDisplay() {
      if (!cartCount) return;
      const count = parseInt(localStorage.getItem('headerCartCount')) || 0;
      cartCount.textContent = count;
    }
    updateCartDisplay();
    window.addEventListener('storage', function(e) {
        if (e.key === 'headerCartCount') {
            updateCartDisplay();
        }
    });
    setInterval(updateCartDisplay, 1000);
    const cartBtn = document.querySelector('.cart-btn');
    if (cartBtn) {
      cartBtn.addEventListener('click', function() {
        updateCartDisplay();
      });
    }

    function checkAuthState() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (currentUser && currentUser.isLoggedIn) {
        if (registerLink) registerLink.style.display = 'none';
        if (signinLink) signinLink.style.display = 'none';
        if (logoutLink) logoutLink.style.display = 'block';
        if (profileLink) profileLink.style.display = 'block';
      } else {
        if (registerLink) registerLink.style.display = 'block';
        if (signinLink) signinLink.style.display = 'block';
        if (logoutLink) logoutLink.style.display = 'none';
        if (profileLink) profileLink.style.display = 'none';
      }
    }
    checkAuthState();

    if (localStorage.getItem('justRegistered') === 'yes') {
      localStorage.removeItem('justRegistered');
      setTimeout(checkAuthState, 100);
    }

    if (logoutLink) {
      logoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('currentUser');
        checkAuthState();
      });
    }

    // زر تسجيل الدخول
    const loginModal = document.getElementById('loginModal');
    if (signinLink) {
      signinLink.addEventListener('click', function(e) {
        e.preventDefault();
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser && currentUser.isLoggedIn) {
          // location.reload(); // يمكنك إعادة تفعيل هذا السطر إذا كنت تريده
        } else {
          loginModal.style.display = 'flex';
        }
      });
    }
    // معالجة تسجيل الدخول
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const user = users.find(u => u.username === username && u.password === password);
        const loginError = document.getElementById('loginError');
        if (!validateUsername(username) || !validatePassword(password)) {
          loginError.textContent = 'يرجى إدخال اسم مستخدم وكلمة مرور صحيحة';
          loginError.style.display = 'block';
          return;
        }
        if (isLoginBlocked(username)) {
          loginError.textContent = 'تم حظر المحاولة مؤقتًا بسبب تكرار المحاولات. حاول لاحقًا.';
          loginError.style.display = 'block';
          return;
        }
        // إظهار اللودينج
        var loading = document.getElementById('loginLoading');
        loading.style.display = 'flex';
        setTimeout(function() {
          loading.style.display = 'none';
          if (user) {
            localStorage.setItem('currentUser', JSON.stringify({ username: user.username, isLoggedIn: true }));
            loginError.style.display = 'none';
            loginModal.style.display = 'none';
            checkAuthState();
            location.reload();
          } else {
            recordFailedLogin(username);
            loginError.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
            loginError.style.display = 'block';
          }
        }, 4000);
      });
    }

    // نسيت كلمة المرور
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    if (forgotPasswordLink) {
      forgotPasswordLink.onclick = function(e) {
        e.preventDefault();
        const modal = document.getElementById('forgotPasswordModal');
        const modalContent = modal.querySelector('div');
        modal.style.display = 'flex';
        setTimeout(() => {
          modalContent.style.transform = 'scale(1)';
          modalContent.style.opacity = '1';
        }, 10);
        document.getElementById('forgotError').style.display = 'none';
        document.getElementById('forgotEmail').value = '';
      };
    }

    document.querySelector('#forgotPasswordModal button').onclick = function() {
      const modal = document.getElementById('forgotPasswordModal');
      const modalContent = modal.querySelector('div');
      modalContent.style.transform = 'scale(0.9)';
      modalContent.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 400);
    };

    if (forgotPasswordForm) {
      forgotPasswordForm.onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('forgotEmail').value.trim();
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const user = users.find(u => u.email === email);
        const forgotError = document.getElementById('forgotError');
        const securityStep = document.getElementById('securityStep');
        const codeStep = document.getElementById('codeStep');
        const finalError = document.getElementById('finalError');
        
        securityStep.style.display = 'none';
        codeStep.style.display = 'none';
        finalError.style.display = 'none';
        
        if (user) {
          forgotError.style.display = 'none';
          securityStep.innerHTML = `
            <form id='securityQuestionsForm' style='animation:fadeIn 0.5s ease;'>
              <label style='display:block;margin-bottom:0.8rem;color:#555;font-size:1.1rem;font-weight:500;'>${getQuestionText(user.secretQ1) || 'سؤال الأمان الأول'}</label>
              <input type='text' id='answer1' required class='form-input' style='width:100%;padding:1rem 1.2rem;border-radius:15px;border:2px solid #eee;font-size:1.1rem;margin-bottom:1.5rem;background:#f8f9fa;transition:all 0.3s ease;'>
              <label style='display:block;margin-bottom:0.8rem;color:#555;font-size:1.1rem;font-weight:500;'>${getQuestionText(user.secretQ2) || 'سؤال الأمان الثاني'}</label>
              <input type='text' id='answer2' required class='form-input' style='width:100%;padding:1rem 1.2rem;border-radius:15px;border:2px solid #eee;font-size:1.1rem;margin-bottom:1.5rem;background:#f8f9fa;transition:all 0.3s ease;'>
              <button type='submit' class='submit-btn' style='background:linear-gradient(45deg, #ff69b4, #ff3380);color:#fff;border:none;border-radius:15px;padding:1.1rem 0;font-weight:bold;width:100%;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 20px rgba(255,105,180,0.3);margin-top:0.5rem;position:relative;overflow:hidden;'>تحقق</button>
            </form>
            <button id='toCodeStep' style='display:none;background:linear-gradient(45deg, #666, #444);color:#fff;border:none;border-radius:15px;padding:1.1rem 0;font-weight:bold;width:100%;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;margin-top:1.5rem;display:flex;align-items:center;justify-content:center;text-align:center;'>الانتقال إلى الاختبار الثاني</button>
          `;
          securityStep.style.display = 'block';
          
          document.getElementById('securityQuestionsForm').onsubmit = function(ev) {
            ev.preventDefault();
            const a1 = document.getElementById('answer1').value.trim().toLowerCase();
            const a2 = document.getElementById('answer2').value.trim().toLowerCase();
            let passed = false;
            if (user.secretA1 && user.secretA2 && 
                a1 === user.secretA1.toLowerCase() && 
                a2 === user.secretA2.toLowerCase()) {
              passed = true;
            }
            if (passed) {
              window.location.href = 'pages/reset-password.html?user='+encodeURIComponent(user.username);
            } else {
              let errMsg = document.getElementById('securityErrorMsg');
              if (!errMsg) {
                errMsg = document.createElement('div');
                errMsg.id = 'securityErrorMsg';
                errMsg.style.color = '#e74c3c';
                errMsg.style.background = '#fff5f5';
                errMsg.style.borderRadius = '10px';
                errMsg.style.padding = '0.7rem 1rem';
                errMsg.style.marginBottom = '1rem';
                errMsg.style.textAlign = 'center';
                errMsg.style.fontWeight = 'bold';
                errMsg.style.fontSize = '1.05rem';
                errMsg.textContent = 'إجاباتك خاطئة! عليك الانتقال إلى الاختبار الثاني.';
                const form = document.getElementById('securityQuestionsForm');
                form.parentNode.insertBefore(errMsg, form.nextSibling);
              } else {
                errMsg.textContent = 'إجاباتك خاطئة! عليك الانتقال إلى الاختبار الثاني.';
                errMsg.style.display = 'block';
              }
              document.getElementById('toCodeStep').style.display = 'block';
            }
          };
          
          document.getElementById('toCodeStep').onclick = function() {
            securityStep.style.display = 'none';
            codeStep.innerHTML = `
              <form id='codeForm' style='animation:fadeIn 0.5s ease;'>
                <label style='display:block;margin-bottom:0.8rem;color:#555;font-size:1.1rem;font-weight:500;'>أدخل الرمز السري الذي اخترته وقت التسجيل</label>
                <input type='text' id='secretCodeInput' required class='form-input' style='width:100%;padding:1rem 1.2rem;border-radius:15px;border:2px solid #eee;font-size:1.1rem;margin-bottom:1.5rem;background:#f8f9fa;transition:all 0.3s ease;'>
                <button type='submit' class='submit-btn' style='background:linear-gradient(45deg, #ff69b4, #ff3380);color:#fff;border:none;border-radius:15px;padding:1.1rem 0;font-weight:bold;width:100%;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 20px rgba(255,105,180,0.3);margin-top:0.5rem;position:relative;overflow:hidden;'>تحقق</button>
              </form>
            `;
            codeStep.style.display = 'block';
            
            document.getElementById('codeForm').onsubmit = function(evv) {
              evv.preventDefault();
              const code = document.getElementById('secretCodeInput').value.trim();
              if (user.secretCode && code === user.secretCode) {
                window.location.href = 'pages/reset-password.html?user='+encodeURIComponent(user.username);
              } else {
                let errMsg = document.getElementById('codeErrorMsg');
                if (!errMsg) {
                  errMsg = document.createElement('div');
                  errMsg.id = 'codeErrorMsg';
                  errMsg.style.color = '#e74c3c';
                  errMsg.style.background = '#fff5f5';
                  errMsg.style.borderRadius = '10px';
                  errMsg.style.padding = '0.7rem 1rem';
                  errMsg.style.marginBottom = '1rem';
                  errMsg.style.textAlign = 'center';
                  errMsg.style.fontWeight = 'bold';
                  errMsg.style.fontSize = '1.05rem';
                  errMsg.textContent = 'حسابك معلق بصفة شبه نهائية. نرجو التواصل مع فريق الدعم بأقرب وقت ممكن.';
                  const form = document.getElementById('codeForm');
                  form.parentNode.insertBefore(errMsg, form.nextSibling);
                } else {
                  errMsg.textContent = 'حسابك معلق بصفة شبه نهائية. نرجو التواصل مع فريق الدعم بأقرب وقت ممكن.';
                  errMsg.style.display = 'block';
                }
              }
            };
          };
        } else {
          forgotError.textContent = 'البريد الإلكتروني غير موجود.';
          forgotError.style.display = 'block';
        }
      };
    }
  });

  function getQuestionText(val) {
    switch(val) {
      case 'school': return 'ما اسم أول مدرسة التحقت بها؟';
      case 'pet': return 'ما اسم حيوانك الأليف الأول؟';
      case 'city': return 'ما هي المدينة التي ولدت فيها؟';
      case 'color': return 'ما هو لونك المفضل؟';
      default: return '';
    }
  }

  // ========== التحقق من صحة البيانات (Validation) ==========
  function validateEmail(email) {
    return /^[^@]+@[^@]+\.[^@]+$/.test(email);
  }
  function validatePassword(password) {
    return password.length >= 5;
  }
  function validateUsername(username) {
    return username.length >= 3;
  }

  // ========== تسجيل الدخول مع Rate Limiting ==========
  const MAX_LOGIN_ATTEMPTS = 5;
  const LOGIN_BLOCK_TIME = 5 * 60 * 1000; // 5 دقائق
  function isLoginBlocked(username) {
    const blockInfo = JSON.parse(localStorage.getItem('loginBlock_' + username));
    if (!blockInfo) return false;
    if (Date.now() > blockInfo.until) {
      localStorage.removeItem('loginBlock_' + username);
      return false;
    }
    return true;
  }
  function recordFailedLogin(username) {
    let info = JSON.parse(localStorage.getItem('loginBlock_' + username)) || { count: 0, until: 0 };
    info.count++;
    if (info.count >= MAX_LOGIN_ATTEMPTS) {
      info.until = Date.now() + LOGIN_BLOCK_TIME;
      info.count = 0;
    }
    localStorage.setItem('loginBlock_' + username, JSON.stringify(info));
  }

  // ========== تحويل كلمات المرور القديمة إلى مشفرة تلقائياً عند تحميل الصفحة ==========
  document.addEventListener('DOMContentLoaded', function() {
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let changed = false;
    users.forEach(u => {
      // إذا كانت كلمة المرور قصيرة (أقل من 20 حرف) اعتبرها نص عادي
      if (u.password && u.password.length < 20) {
        u.password = bcrypt.hashSync(u.password, 10);
        changed = true;
      }
    });
    if (changed) {
      localStorage.setItem('users', JSON.stringify(users));
    }
  });

  // ========== مثال توضيحي لتشفير كلمة المرور عند التسجيل ==========
  // عند تسجيل مستخدم جديد (مثال):
  function registerUser(user) {
    if (!validateEmail(user.email) || !validateUsername(user.username) || !validatePassword(user.password)) {
      alert('يرجى إدخال بيانات صحيحة');
      return false;
    }
    // تشفير كلمة المرور دائماً
    user.password = bcrypt.hashSync(user.password, 10);
    // ... أكمل الحفظ في localStorage ...
  }
  </script>

  <!-- عنصر اللودينج المحسن -->
  <div id="loginLoading" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.65);z-index:99999;align-items:center;justify-content:center;backdrop-filter:blur(2px);">
    <div style="background:linear-gradient(135deg,#fff 60%,#ffe5f7 100%);padding:2.5rem 2.8rem 2.2rem 2.8rem;border-radius:22px;box-shadow:0 8px 32px 0 rgba(255,105,180,0.18),0 1.5px 8px rgba(255,105,180,0.08);display:flex;flex-direction:column;align-items:center;">
      <div class="loader-glow"></div>
      <div class="loading-text">جاري تسجيل الدخول...</div>
    </div>
  </div>

  <h1>TEST</h1>
</body>
</html>
